/*
 0.2.5d обновление касс и изменение настроек

cscript update.min.js <install> <license> <variable> <logotype> <table> <silent>

<install>	- относительный путь к файлу установки драйвера или false для пропуска.
<license>	- относительный путь к файлу лицензий для касс или false для пропуска.
<variable>	- относительный путь к файлу с переменными или false для пропуска.
<logotype>	- относительный путь к BMP файлу логотипа для печати вверху чека.
<table>		- относительный путь к файлу таблиц для импорта в формате Штрих-М.
<silent>	- выполнять тихую установку без остановки работы пользователя

*/
(function(g,r){var a,t,p,v,l,u,m,w,x=!1,b=0;var A=function(a,b){var c=[];if(a&&b){c=a.split("|");for(var e=c.length,d=e-1;-1<d;d--)if(c[d])if(a=c[d].split("%"),a.length%2){for(var f=1,g=a.length,h=!0;f<g;f+=2)a[f]in b?a[f]=b[a[f]]:h=!1;h?c[d]=a.join(""):c.splice(d,1)}else c.splice(d,1);else d&&d<e-1&&(c[d]="|")}return c.join("")};r=new ActiveXObject("WScript.Shell");var h=new ActiveXObject("Scripting.FileSystemObject");!b&&0<g.arguments.length&&(a=g.arguments(0))&&"false"!=a.toLowerCase()&&(t=h.getAbsolutePathName(a));
!b&&1<g.arguments.length&&(a=g.arguments(1))&&"false"!=a.toLowerCase()&&(l=h.getAbsolutePathName(a));!b&&2<g.arguments.length&&(a=g.arguments(2))&&"false"!=a.toLowerCase()&&(u=h.getAbsolutePathName(a));!b&&3<g.arguments.length&&(a=g.arguments(3))&&"false"!=a.toLowerCase()&&(m=h.getAbsolutePathName(a));!b&&4<g.arguments.length&&(a=g.arguments(4))&&"false"!=a.toLowerCase()&&(w=h.getAbsolutePathName(a));!b&&5<g.arguments.length&&(a=g.arguments(5),x="true"==a.toLowerCase());b||!t||h.fileExists(t)||(b=
1);b||!l||h.fileExists(l)||(b=2);b||!u||h.fileExists(u)||(b=3);b||!m||h.fileExists(m)||(b=4);b||!w||h.fileExists(w)||(b=5);x||(b||(r.run('shutdown /r /t 60 /c "Через минуту на компьютер будет установлено обновление для ККМ. Нужно будет закрыть кассу программы еФарма. Закрывать смену при этом не нужно. Установка займёт три минуты. После этого вы сможете работать."',0,!1),g.sleep(3E4),r.run("shutdown /a",0,!0)),b||(r.run("taskkill /F /IM ePlus.ARMCasherNew.exe /T",0,!0),g.sleep(2E3)));if(t){b||r.run('cscript uninstall.js all "Штрих" "Драйвер ФР" "" "/verysilent"',
0,!0);if(!b){var e=[{path:"C:\\Program Files\\SHTRIH-M",filter:"DrvFR"},{path:"C:\\Program Files (x86)\\SHTRIH-M",filter:"DrvFR"},{path:"C:\\ProgramData\\Microsoft\\Windows\\Start Menu\\Programs\\ШТРИХ-М",filter:"ФР"}];for(var c=0,n=e.length;c<n;c++){var f=e[c];if(h.folderExists(f.path))for(a=h.getFolder(f.path),v=new Enumerator(a.subFolders);!v.atEnd();){a=v.item();if(~a.name.indexOf(f.filter))try{a.Delete(!0)}catch(z){}v.moveNext()}}}b||(a=r.run('"'+t+'" /verysilent',0,!0))&&(b=6)}if(m||w||l){if(!b)try{var d=
new ActiveXObject("Addin.DrvFR")}catch(z){b=7}if(!b)switch(d.Password=30,d.GetECRStatus(),d.ResultCode){case 0:break;case -1:b=8;break;case -3:b=9;break;default:b=10}}if(l){b||(a=h.openTextFile(l,1),a.atEndOfStream?b=11:p=a.readAll(),a.close());if(!b)for(e=p.split("\r\n"),c=0,n=e.length;c<n;c++)e[c]=e[c].split("\t"),3==e[c].length?(f={serial:e[c][0],license:e[c][1],signature:e[c][2]},e[c]=f):e[c]=null;if(!b)if(d.ReadSerialNumber(),d.ResultCode)b=12;else{var k=!1;c=0;for(n=e.length;c<n&&!b;c++)(f=
e[c])&&d.SerialNumber==f.serial&&(d.License=f.license,d.DigitalSign=f.signature,d.WriteFeatureLicenses(),d.ResultCode?b=13:k=!0)}b||k||(b=14)}if(u){if(!b){var q=new ActiveXObject("WScript.Network");q=q.computerName.toLowerCase()}b||(a=h.openTextFile(u,1),a.atEndOfStream?b=15:p=a.readAll(),a.close(),u=null);if(!b)for(e=p.split("\r\n"),k=!1,c=0,n=e.length;c<n&&!k;c++)if(e[c]=e[c].split("\t"),c){f={};l=0;for(v=e[0].length;l<v;l++)t=e[0][l],a=e[c][l],!l&&a&&(a=a.toLowerCase()),t&&a&&(f[t]=a);q.indexOf(f.name)||
(u=f,k=!0)}}if(m){if(!b)for(q=new ActiveXObject("WIA.ImageFile"),q.loadFile(m),p="",m=0;128>m;m++)for(k=0;512>k;k++){k<q.width&&m<q.height?(a=q.ARGBData(k+m*q.width+1),a=-16777216==a?1:0):a=0;var y=k%8?y:0;y+=a?Math.pow(2,k%8):0;7==k%8&&(p+=String.fromCharCode(y))}b||(d.LineNumber=1,d.LineData=p,d.WideLoadLineData(),d.ResultCode&&(b=15))}if(w){b||(a=h.openTextFile(w,1,!1,-1),a.atEndOfStream?b=16:p=a.readAll(),a.close());if(!b)for(e=p.split("\r\n"),c=0,n=e.length;c<n;c++)a=e[c],e[c]=e[c].split(","),
3<e[c].length&&a.indexOf("//")?(a=a.split("','")[1]||"",a=a.substr(0,a.length-1),a=A(a,u||{}),f={table:e[c][0],row:e[c][1],field:e[c][2],value:a},e[c]=f):e[c]=null;if(!b)for(c=0,n=e.length;c<n;c++)if(f=e[c])d.TableNumber=f.table,d.RowNumber=f.row,d.FieldNumber=f.field,d.GetFieldStruct(),d.ResultCode||(d.ReadTable(),d.ResultCode||(a=d.FieldType?d.ValueOfFieldString:d.ValueOfFieldInteger,a!=f.value&&(d.FieldType?d.ValueOfFieldString=f.value:d.ValueOfFieldInteger=f.value,d.WriteTable())))}x||(r.run('shutdown /r /t 60 /c "Установка обновления для ККМ завершена. Можете продолжать работу."',
0,!1),g.sleep(3E4),r.run("shutdown /a",0,!0));g.quit(b)})(WSH);
