/*
 0.2.6 обновление касс и изменение настроек

cscript update.min.js <install> <license> <variable> <logotype> <table> <silent>

<install>	- относительный путь к файлу установки драйвера или false для пропуска.
<license>	- относительный путь к файлу лицензий для касс или false для пропуска.
<variable>	- относительный путь к файлу с переменными или false для пропуска.
<logotype>	- относительный путь к BMP файлу логотипа для печати вверху чека.
<table>		- относительный путь к файлу таблиц для импорта в формате Штрих-М.
<silent>	- выполнять тихую установку без остановки работы пользователя

*/
(function(g,q){var a,r,u,v,l,t,m,w,x=!1,c=0;var A=function(a,c){var b=[];if(a&&c){b=a.split("|");for(var d=b.length,e=d-1;-1<e;e--)if(b[e])if(a=b[e].split("%"),a.length%2){for(var f=1,g=a.length,h=!0;f<g;f+=2)a[f]in c?a[f]=c[a[f]]:h=!1;h?b[e]=a.join(""):b.splice(e,1)}else b.splice(e,1);else e&&e<d-1&&(b[e]="|")}return b.join("")};var B=function(a,c){var b="";a=Number(a);do b="0123456789ABCDEF".charAt(a%16)+b,a=Math.floor(a/16);while(a);for(;b.length<c;)b="0"+b;return b};q=new ActiveXObject("WScript.Shell");
var h=new ActiveXObject("Scripting.FileSystemObject");!c&&0<g.arguments.length&&(a=g.arguments(0))&&"false"!=a.toLowerCase()&&(r=h.getAbsolutePathName(a));!c&&1<g.arguments.length&&(a=g.arguments(1))&&"false"!=a.toLowerCase()&&(l=h.getAbsolutePathName(a));!c&&2<g.arguments.length&&(a=g.arguments(2))&&"false"!=a.toLowerCase()&&(t=h.getAbsolutePathName(a));!c&&3<g.arguments.length&&(a=g.arguments(3))&&"false"!=a.toLowerCase()&&(m=h.getAbsolutePathName(a));!c&&4<g.arguments.length&&(a=g.arguments(4))&&
"false"!=a.toLowerCase()&&(w=h.getAbsolutePathName(a));!c&&5<g.arguments.length&&(a=g.arguments(5),x="true"==a.toLowerCase());c||!r||h.fileExists(r)||(c=1);c||!l||h.fileExists(l)||(c=2);c||!t||h.fileExists(t)||(c=3);c||!m||h.fileExists(m)||(c=4);c||!w||h.fileExists(w)||(c=5);x||(c||(q.run('shutdown /r /t 60 /c "Через 2 минуты на компьютер будет установлено обновление для ККМ. Нужно будет закрыть кассу программы еФарма. Закрывать смену при этом не нужно. Установка займёт 3 минуты. После этого вы сможете работать."',
0,!1),g.sleep(3E4),q.run("shutdown /a",0,!0),g.sleep(9E4)),c||(q.run("taskkill /F /IM ePlus.ARMCasherNew.exe /T",0,!0),g.sleep(2E3)));if(r){c||q.run('cscript uninstall.js all "Штрих" "Драйвер ФР" "" "/verysilent"',0,!0);if(!c){var d=[{path:"C:\\Program Files\\SHTRIH-M",filter:"DrvFR"},{path:"C:\\Program Files (x86)\\SHTRIH-M",filter:"DrvFR"},{path:"C:\\ProgramData\\Microsoft\\Windows\\Start Menu\\Programs\\ШТРИХ-М",filter:"ФР"}];for(var b=0,n=d.length;b<n;b++){var f=d[b];if(h.folderExists(f.path))for(a=
h.getFolder(f.path),v=new Enumerator(a.subFolders);!v.atEnd();){a=v.item();if(~a.name.indexOf(f.filter))try{a.Delete(!0)}catch(z){}v.moveNext()}}}c||(a=q.run('"'+r+'" /verysilent',0,!0))&&(c=6)}if(m||w||l){if(!c)try{var e=new ActiveXObject("Addin.DrvFR")}catch(z){c=7}if(!c)switch(e.Password=30,e.GetECRStatus(),e.ResultCode){case 0:break;case -1:c=8;break;case -3:c=9;break;default:c=10}}if(l){c||(a=h.openTextFile(l,1),a.atEndOfStream?c=11:u=a.readAll(),a.close());if(!c)for(d=u.split("\r\n"),b=0,n=
d.length;b<n;b++)d[b]=d[b].split("\t"),3==d[b].length?(f={serial:d[b][0],license:d[b][1],signature:d[b][2]},d[b]=f):d[b]=null;if(!c)if(e.ReadSerialNumber(),e.ResultCode)c=12;else{var k=!1;b=0;for(n=d.length;b<n&&!c;b++)(f=d[b])&&e.SerialNumber==f.serial&&(e.License=f.license,e.DigitalSign=f.signature,e.WriteFeatureLicenses(),e.ResultCode?c=13:k=!0)}c||k||(c=14)}if(t){if(!c){var p=new ActiveXObject("WScript.Network");p=p.computerName.toLowerCase()}c||(a=h.openTextFile(t,1),a.atEndOfStream?c=15:u=a.readAll(),
a.close(),t=null);if(!c)for(d=u.split("\r\n"),k=!1,b=0,n=d.length;b<n&&!k;b++)if(d[b]=d[b].split("\t"),b){f={};l=0;for(v=d[0].length;l<v;l++)r=d[0][l],a=d[b][l],!l&&a&&(a=a.toLowerCase()),r&&a&&(f[r]=a);p.indexOf(f.name)||(t=f,k=!0)}}if(m){if(!c)for(p=new ActiveXObject("WIA.ImageFile"),p.loadFile(m),d=[],m=0;128>m;m++)for(k=0;512>k;k++){k<p.width&&m<p.height?(a=p.ARGBData(k+m*p.width+1),a=-16777216==a?1:0):a=0;var y=k%8?y:0;y+=a?Math.pow(2,k%8):0;7==k%8&&d.push(B(y,2))}c||(e.LineNumber=0,e.LineDataHex=
d.join(" "),e.WideLoadLineData(),e.ResultCode&&(c=15))}if(w){c||(a=h.openTextFile(w,1,!1,-1),a.atEndOfStream?c=16:u=a.readAll(),a.close());if(!c)for(d=u.split("\r\n"),b=0,n=d.length;b<n;b++)a=d[b],d[b]=d[b].split(","),3<d[b].length&&a.indexOf("//")?(a=a.split("','")[1]||"",a=a.substr(0,a.length-1),a=A(a,t||{}),f={table:d[b][0],row:d[b][1],field:d[b][2],value:a},d[b]=f):d[b]=null;if(!c)for(b=0,n=d.length;b<n;b++)if(f=d[b])e.TableNumber=f.table,e.RowNumber=f.row,e.FieldNumber=f.field,e.GetFieldStruct(),
e.ResultCode||(e.ReadTable(),e.ResultCode||(a=e.FieldType?e.ValueOfFieldString:e.ValueOfFieldInteger,a!=f.value&&(e.FieldType?e.ValueOfFieldString=f.value:e.ValueOfFieldInteger=f.value,e.WriteTable())))}x||(q.run('shutdown /r /t 60 /c "Установка обновления для ККМ завершена. Можете продолжать работу."',0,!1),g.sleep(3E4),q.run("shutdown /a",0,!0));g.quit(c)})(WSH);
