/*
 0.2.7 обновление касс и изменение настроек

cscript update.min.js <install> <license> <variable> <logotype> <table> <silent>

<install>	- относительный путь к файлу установки драйвера или false для пропуска.
<license>	- шаблон пути к файлу лицензий для касс или false для пропуска.
<variable>	- шаблон пути к файлу с переменными или false для пропуска.
<logotype>	- шаблон пути к BMP файлу логотипа для печати вверху чека.
<table>		- шаблон пути к файлу таблиц для импорта в формате Штрих-М.
<silent>	- выполнять тихую установку без остановки работы пользователя

*/
(function(g,q){var a,r,u,v,l,t,m,w,x,z=!1,c=0;var y=function(a,c){var b=[];if(a&&c){b=a.split("|");for(var e=b.length,d=e-1;-1<d;d--)if(b[d])if(a=b[d].split("%"),a.length%2){for(var f=1,g=a.length,h=!0;f<g;f+=2)a[f]in c?a[f]=c[a[f]]:h=!1;h?b[d]=a.join(""):b.splice(d,1)}else b.splice(d,1);else d&&d<e-1&&(b[d]="|")}return b.join("")};var C=function(a,c){var b="";a=Number(a);do b="0123456789ABCDEF".charAt(a%16)+b,a=Math.floor(a/16);while(a);for(;b.length<c;)b="0"+b;return b};q=new ActiveXObject("WScript.Shell");
var h=new ActiveXObject("Scripting.FileSystemObject");!c&&0<g.arguments.length&&(a=g.arguments(0))&&"false"!=a.toLowerCase()&&(r=a);!c&&1<g.arguments.length&&(a=g.arguments(1))&&"false"!=a.toLowerCase()&&(l=a);!c&&2<g.arguments.length&&(a=g.arguments(2))&&"false"!=a.toLowerCase()&&(t=a);!c&&3<g.arguments.length&&(a=g.arguments(3))&&"false"!=a.toLowerCase()&&(m=a);!c&&4<g.arguments.length&&(a=g.arguments(4))&&"false"!=a.toLowerCase()&&(w=a);!c&&5<g.arguments.length&&(a=g.arguments(5),z="true"==a.toLowerCase());
z||(c||(q.run('shutdown /r /t 60 /c "Через 2 минуты на компьютер будет установлено обновление для ККМ. Нужно будет закрыть кассу программы еФарма. Закрывать смену при этом не нужно. Установка займёт 3 минуты. После этого вы сможете работать."',0,!1),g.sleep(3E4),q.run("shutdown /a",0,!0),g.sleep(9E4)),c||(q.run("taskkill /F /IM ePlus.ARMCasherNew.exe /T",0,!0),g.sleep(2E3)));if(r){c||(a=h.getAbsolutePathName(r),h.fileExists(a)?r=a:c=1);c||q.run('cscript uninstall.js all "Штрих" "Драйвер ФР" "" "/verysilent"',
0,!0);if(!c){var e=[{path:"C:\\Program Files\\SHTRIH-M",filter:"DrvFR"},{path:"C:\\Program Files (x86)\\SHTRIH-M",filter:"DrvFR"},{path:"C:\\ProgramData\\Microsoft\\Windows\\Start Menu\\Programs\\ШТРИХ-М",filter:"ФР"}];for(var b=0,n=e.length;b<n;b++){var f=e[b];if(h.folderExists(f.path))for(a=h.getFolder(f.path),v=new Enumerator(a.subFolders);!v.atEnd();){a=v.item();if(~a.name.indexOf(f.filter))try{a.Delete(!0)}catch(B){}v.moveNext()}}}c||(a=q.run('"'+r+'" /verysilent',0,!0))&&(c=2)}if(m||w||l){if(!c)try{var d=
new ActiveXObject("Addin.DrvFR")}catch(B){c=3}if(!c)switch(d.Password=30,d.GetECRStatus(),d.ResultCode){case 0:break;case -1:c=4;break;case -3:c=5;break;default:c=6}c||(d.GetDeviceMetrics(),d.ResultCode?c=7:x=d.UModel)}if(l){c||(a=y(l,{model:x}),a=h.getAbsolutePathName(a),h.fileExists(a)?l=a:c=8);c||(a=h.openTextFile(l,1),a.atEndOfStream?c=9:u=a.readAll(),a.close());if(!c)for(e=u.split("\r\n"),b=0,n=e.length;b<n;b++)e[b]=e[b].split("\t"),3==e[b].length?(f={serial:e[b][0],license:e[b][1],signature:e[b][2]},
e[b]=f):e[b]=null;if(!c)if(d.ReadSerialNumber(),d.ResultCode)c=10;else{var k=!1;b=0;for(n=e.length;b<n&&!c;b++)(f=e[b])&&d.SerialNumber==f.serial&&(d.License=f.license,d.DigitalSign=f.signature,d.WriteFeatureLicenses(),d.ResultCode?c=11:k=!0)}c||k||(c=12)}if(t){if(!c){var p=new ActiveXObject("WScript.Network");p=p.computerName.toLowerCase()}c||(a=y(t,{model:x}),a=h.getAbsolutePathName(a),h.fileExists(a)?t=a:c=13);c||(a=h.openTextFile(t,1),a.atEndOfStream?c=14:u=a.readAll(),a.close(),t=null);if(!c)for(e=
u.split("\r\n"),k=!1,b=0,n=e.length;b<n&&!k;b++)if(e[b]=e[b].split("\t"),b){f={};l=0;for(v=e[0].length;l<v;l++)r=e[0][l],a=e[b][l],!l&&a&&(a=a.toLowerCase()),r&&a&&(f[r]=a);p.indexOf(f.name)||(t=f,k=!0)}}if(m){c||(a=y(m,{model:x}),a=h.getAbsolutePathName(a),h.fileExists(a)?m=a:c=15);if(!c)for(p=new ActiveXObject("WIA.ImageFile"),p.loadFile(m),e=[],m=0;128>m;m++)for(k=0;512>k;k++){k<p.width&&m<p.height?(a=p.ARGBData(k+m*p.width+1),a=-16777216==a?1:0):a=0;var A=k%8?A:0;A+=a?Math.pow(2,k%8):0;7==k%8&&
e.push(C(A,2))}c||(d.LineNumber=0,d.LineDataHex=e.join(" "),d.WideLoadLineData(),d.ResultCode&&(c=16))}if(w){c||(a=y(w,{model:x}),a=h.getAbsolutePathName(a),h.fileExists(a)?w=a:c=17);c||(a=h.openTextFile(w,1,!1,-1),a.atEndOfStream?c=18:u=a.readAll(),a.close());if(!c)for(e=u.split("\r\n"),b=0,n=e.length;b<n;b++)a=e[b],e[b]=e[b].split(","),3<e[b].length&&a.indexOf("//")?(a=a.split("','")[1]||"",a=a.substr(0,a.length-1),a=y(a,t||{}),f={table:e[b][0],row:e[b][1],field:e[b][2],value:a},e[b]=f):e[b]=null;
if(!c)for(b=0,n=e.length;b<n;b++)if(f=e[b])d.TableNumber=f.table,d.RowNumber=f.row,d.FieldNumber=f.field,d.GetFieldStruct(),d.ResultCode||(d.ReadTable(),d.ResultCode||(a=d.FieldType?d.ValueOfFieldString:d.ValueOfFieldInteger,a!=f.value&&(d.FieldType?d.ValueOfFieldString=f.value:d.ValueOfFieldInteger=f.value,d.WriteTable())))}z||(q.run('shutdown /r /t 60 /c "Установка обновления для ККМ завершена. Можете продолжать работу."',0,!1),g.sleep(3E4),q.run("shutdown /a",0,!0));g.quit(c)})(WSH);
