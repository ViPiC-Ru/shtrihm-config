/*
 0.2.0 обновление касс в связи со сменой ндс

cscript update.min.js [[[<install>] <config>] <license>]

<install>	- относительный путь к файлу установки драйвера или false для пропуска.
<config>	- true если нужно внести изменения в настройки кассы или false для пропуска.
<license>	- относительный путь к файлу лицензий для касс или false для пропуска.

*/
(function(h,k){var d,g,e,l=null,c=null,p=!0,a=0;k=new ActiveXObject("WScript.Shell");var m=new ActiveXObject("Scripting.FileSystemObject");!a&&0<h.arguments.length&&(d=h.arguments(0))&&"false"!=d.toLowerCase()&&(e=m.getAbsolutePathName(d));!a&&1<h.arguments.length&&(d=h.arguments(1),l="true"==d.toLowerCase());!a&&2<h.arguments.length&&(d=h.arguments(2))&&"false"!=d.toLowerCase()&&(g=m.getAbsolutePathName(d));a||!e||m.fileExists(e)||(a=1);a||!g||m.fileExists(g)||(a=2);a||(p=!e&&!l&&!g);p||(d="Через минуту на компьютер будет установлено обновление для ККМ. Нужно будет закрыть кассу программы еФарма. Закрывать смену при этом не нужно. Установка займёт три минуты. После этого вы сможете работать.",
k.run('shutdown /r /t 60 /c "'+d+'"',0,!1),h.sleep(3E4),k.run("shutdown /a",0,!0));a||p||(k.run("taskkill /F /IM ePlus.ARMCasherNew.exe /T",0,!0),h.sleep(1E3));e&&(a||(d='all "Штрих" "Драйвер ФР" "" "/verysilent"',k.run("cscript uninstall.js "+d,0,!0)),a||(d=k.run('"'+e+'" /verysilent',0,!0))&&(a=3));if(l||g){if(!a)try{var b=new ActiveXObject("Addin.DrvFR")}catch(r){a=4}if(!a)switch(b.Password=30,b.GetECRStatus(),c=!1,b.ResultCode){case 0:c=!0;break;case -1:break;case -3:a=5;break;default:a=6}}if(!a&&
l&&c){b.Password=30;var f=[{table:17,row:1,field:3,value:2},{table:17,row:1,field:10,value:1},{table:17,row:1,field:12,value:7},{table:17,row:1,field:17,value:2},{table:23,row:1,field:1,value:1},{table:23,row:1,field:5,value:1},{table:23,row:1,field:6,value:1}];c=0;for(var n=f.length;c<n&&!a;c++)e=f[c],b.TableNumber=e.table,b.RowNumber=e.row,b.FieldNumber=e.field,b.GetFieldStruct(),b.ResultCode?a=7:(b.ReadTable(),b.ResultCode?a=8:(d=b.FieldType?b.ValueOfFieldString:b.ValueOfFieldInteger,d!=e.value&&
(b.FieldType?b.ValueOfFieldString=e.value:b.ValueOfFieldInteger=e.value,b.WriteTable(),b.ResultCode&&(a=9))))}if(g){a||(g=m.openTextFile(g,1),g.atEndOfStream?a=10:d=g.readAll(),g.close());if(!a)for(f=d.split("\r\n"),c=0,n=f.length;c<n&&!a;c++)f[c]=f[c].split("\t"),3==f[c].length&&(e={serial:f[c][0],license:f[c][1],signature:f[c][2]},f[c]=e);if(!a)if(b.Password=30,b.ReadSerialNumber(),b.ResultCode)a=11;else{var q=!1;c=0;for(n=f.length;c<n&&!a;c++)e=f[c],b.SerialNumber==e.serial&&(b.License=e.license,
b.DigitalSign=e.signature,b.WriteFeatureLicenses(),b.ResultCode?a=12:q=!0)}a||q||(a=13)}p||(d="Установка обновления завершена. Можете продолжать работу.",l&&(d+=" Вечером после закрытия смены, закройте кассу программы еФарма, но не выключайте сам фискальный аппарат, на него будут установлены обновления. На следующий рабочий день, после открытия смены, после первой продажи необходимо сделать внесение в кассу программы еФарма, т.к. после установки обновений это значение обнулится. При возникновении трудностей создайте заявку в ИТ отдел."),
k.run('shutdown /r /t 60 /c "'+d+'"',0,!1),h.sleep(45E3),k.run("shutdown /a",0,!0));h.quit(a)})(WSH);
