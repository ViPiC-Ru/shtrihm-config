/* 1.0.0 расширенная настройка касс

cscript config.min.js [<install> [<license> [<variable> [<logotype> [<table> [<silent>]]]]]]

<install>   - Относительный путь к файлу установки драйвера или false для пропуска.
<license>   - Шаблон пути к файлу лицензий для касс или false для пропуска.
<variable>  - Шаблон пути к файлу с переменными или false для пропуска.
<logotype>  - Шаблон пути к BMP файлу логотипа для печати вверху чека.
<table>     - Шаблон пути к файлу таблиц для импорта в формате Штрих-М.
<silent>    - Выполнять тихую установку без остановки работы пользователя.

 */

(function(h,u){var a,v,x,y,n,w,p,z,A,E=!1,b=0;var D=function(g,B){var k=[];if(g&&B){k=g.split("|");for(var G=k.length,r=G-1;-1<r;r--)if(k[r])if(g=k[r].split("%"),g.length%2){for(var C=1,I=g.length,H=!0;C<I;C+=2)g[C]in B?g[C]=B[g[C]]:H=!1;H?k[r]=g.join(""):k.splice(r,1)}else k.splice(r,1);else r&&r<G-1&&(k[r]="|")}return k.join("")};var J=function(g,B){var k="";g=Number(g);do k="0123456789ABCDEF".charAt(g%16)+k,g=Math.floor(g/16);while(g);for(;k.length<B;)k="0"+k;return k};u=new ActiveXObject("WScript.Shell");
var l=new ActiveXObject("Scripting.FileSystemObject");!b&&0<h.arguments.length&&(a=h.arguments(0))&&"false"!=a.toLowerCase()&&(v=a);!b&&1<h.arguments.length&&(a=h.arguments(1))&&"false"!=a.toLowerCase()&&(n=a);!b&&2<h.arguments.length&&(a=h.arguments(2))&&"false"!=a.toLowerCase()&&(w=a);!b&&3<h.arguments.length&&(a=h.arguments(3))&&"false"!=a.toLowerCase()&&(p=a);!b&&4<h.arguments.length&&(a=h.arguments(4))&&"false"!=a.toLowerCase()&&(z=a);!b&&5<h.arguments.length&&(a=h.arguments(5),E="true"==a.toLowerCase());
E||(b||(u.run('shutdown /r /t 60 /c "Через 2 минуты на компьютер будет установлено обновление для ККМ. Нужно будет закрыть кассу программы еФарма. Закрывать смену при этом не нужно. Установка займёт 3 минуты. После этого вы сможете работать."',0,!1),h.sleep(3E4),u.run("shutdown /a",0,!0),h.sleep(9E4)),b||(u.run("taskkill /F /IM ePlus.ARMCasherNew.exe /T",0,!0),h.sleep(2E3)));if(v){b||(a=l.getAbsolutePathName(v),l.fileExists(a)?v=a:b=1);b||u.run('cscript uninstall.js all "Штрих" "Драйвер ФР" "" "/verysilent"',
0,!0);if(!b){var d=[{path:"C:\\Program Files\\SHTRIH-M",filter:"DrvFR"},{path:"C:\\Program Files (x86)\\SHTRIH-M",filter:"DrvFR"},{path:"C:\\ProgramData\\Microsoft\\Windows\\Start Menu\\Programs\\ШТРИХ-М",filter:"ФР"}];for(var c=0,q=d.length;c<q;c++){var f=d[c];if(l.folderExists(f.path))for(a=l.getFolder(f.path),y=new Enumerator(a.subFolders);!y.atEnd();){a=y.item();if(~a.name.indexOf(f.filter))try{a.Delete(!0)}catch(g){}y.moveNext()}}}b||(a=u.run('"'+v+'" /verysilent',0,!0))&&(b=2)}if(p||z||n){if(!b)try{var e=
new ActiveXObject("Addin.DrvFR")}catch(g){b=3}if(!b)switch(e.Password=30,e.GetECRStatus(),e.ResultCode){case 0:break;case -1:b=4;break;case -3:b=5;break;default:b=6}b||(e.GetDeviceMetrics(),e.ResultCode?b=7:A=e.UModel)}if(n){b||(a=D(n,{model:A}),a=l.getAbsolutePathName(a),l.fileExists(a)?n=a:b=8);b||(a=l.openTextFile(n,1),a.atEndOfStream?b=9:x=a.readAll(),a.close());if(!b)for(d=x.split("\r\n"),c=0,q=d.length;c<q;c++)d[c]=d[c].split("\t"),3==d[c].length?(f={serial:d[c][0],license:d[c][1],signature:d[c][2]},
d[c]=f):d[c]=null;if(!b)if(e.ReadSerialNumber(),e.ResultCode)b=10;else{var m=!1;c=0;for(q=d.length;c<q&&!b;c++)(f=d[c])&&e.SerialNumber==f.serial&&(e.License=f.license,e.DigitalSign=f.signature,e.WriteFeatureLicenses(),e.ResultCode?b=11:m=!0)}b||m||(b=12)}if(w){if(!b){var t=new ActiveXObject("WScript.Network");t=t.computerName.toLowerCase()}b||(a=D(w,{model:A}),a=l.getAbsolutePathName(a),l.fileExists(a)?w=a:b=13);b||(a=l.openTextFile(w,1),a.atEndOfStream?b=14:x=a.readAll(),a.close(),w=null);if(!b)for(d=
x.split("\r\n"),m=!1,c=0,q=d.length;c<q&&!m;c++)if(d[c]=d[c].split("\t"),c){f={};n=0;for(y=d[0].length;n<y;n++)v=d[0][n],a=d[c][n],!n&&a&&(a=a.toLowerCase()),v&&a&&(f[v]=a);t.indexOf(f.name)||(w=f,m=!0)}}if(p){b||(a=D(p,{model:A}),a=l.getAbsolutePathName(a),l.fileExists(a)?p=a:b=15);if(!b)for(t=new ActiveXObject("WIA.ImageFile"),t.loadFile(p),d=[],p=0;128>p;p++)for(m=0;512>m;m++){m<t.width&&p<t.height?(a=t.ARGBData(m+p*t.width+1),a=-16777216==a?1:0):a=0;var F=m%8?F:0;F+=a?Math.pow(2,m%8):0;7==m%8&&
d.push(J(F,2))}b||(e.LineNumber=0,e.LineDataHex=d.join(" "),e.WideLoadLineData(),e.ResultCode&&(b=16))}if(z){b||(a=D(z,{model:A}),a=l.getAbsolutePathName(a),l.fileExists(a)?z=a:b=17);b||(a=l.openTextFile(z,1,!1,-1),a.atEndOfStream?b=18:x=a.readAll(),a.close());if(!b)for(d=x.split("\r\n"),c=0,q=d.length;c<q;c++)a=d[c],d[c]=d[c].split(","),3<d[c].length&&a.indexOf("//")?(a=a.split("','")[1]||"",a=a.substr(0,a.length-1),a=D(a,w||{}),f={table:d[c][0],row:d[c][1],field:d[c][2],value:a},d[c]=f):d[c]=null;
if(!b)for(c=0,q=d.length;c<q;c++)if(f=d[c])e.TableNumber=f.table,e.RowNumber=f.row,e.FieldNumber=f.field,e.GetFieldStruct(),e.ResultCode||(e.ReadTable(),e.ResultCode||(a=e.FieldType?e.ValueOfFieldString:e.ValueOfFieldInteger,a!=f.value&&(e.FieldType?e.ValueOfFieldString=f.value:e.ValueOfFieldInteger=f.value,e.WriteTable())))}E||(u.run('shutdown /r /t 60 /c "Установка обновления для ККМ завершена. Можете продолжать работу."',0,!1),h.sleep(3E4),u.run("shutdown /a",0,!0));h.quit(b)})(WSH);
